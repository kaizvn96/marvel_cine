# docker-compose.yml (Generated by Sail, updated with Redis)

services:
    # Service chính cho ứng dụng Laravel (Chạy PHP 8.4 theo runtime của Sail)
    laravel.test:
        build:
            context: './vendor/laravel/sail/runtimes/8.4'
            dockerfile: Dockerfile
            args:
                WWWGROUP: '${WWWGROUP}' # Biến môi trường cho group user (thường không cần sửa)
        image: 'sail-8.4/app' # Tên image sẽ được build
        extra_hosts:
            # Giúp container kết nối lại host machine (hữu ích cho Xdebug)
            - 'host.docker.internal:host-gateway'
        ports:
            # Map cổng bên trong container (luôn là 80 cho web server của Sail)
            # ra cổng trên máy NAS (mặc định là 80, hoặc lấy từ biến APP_PORT trong .env)
            # ---> Sửa thành '8080:80' nếu bạn muốn luôn dùng cổng 8080
            # ---> Hoặc đặt APP_PORT=8080 trong file .env
            - '${APP_PORT:-80}:80'
            # Map cổng cho Vite hot reload (nếu dùng sail npm run dev)
            - '${VITE_PORT:-5173}:${VITE_PORT:-5173}'
        environment:
            WWWUSER: '${WWWUSER}' # Biến môi trường cho user (thường không cần sửa)
            LARAVEL_SAIL: 1      # Báo cho Laravel biết đang chạy với Sail
            XDEBUG_MODE: '${SAIL_XDEBUG_MODE:-off}' # Cấu hình Xdebug (mặc định tắt)
            XDEBUG_CONFIG: '${SAIL_XDEBUG_CONFIG:-client_host=host.docker.internal}'
            IGNITION_LOCAL_SITES_PATH: '${PWD}' # Giúp trang lỗi Ignition hiển thị tốt hơn
        volumes:
            # Mount toàn bộ thư mục dự án hiện tại (.) vào /var/www/html trong container
            - '.:/var/www/html'
        networks:
            # Kết nối vào network tên 'sail'
            - sail
        # Khai báo các service phụ thuộc (app sẽ đợi mysql và redis khởi động xong)
        depends_on: # <<< ĐÃ THÊM REDIS VÀO ĐÂY
            - mysql
            - redis

    # Service cho Database MySQL
    mysql:
        image: 'mysql/mysql-server:8.0' # Sail mặc định dùng MySQL 8.0
        ports:
            # Map cổng MySQL ra ngoài nếu cần kết nối bằng tool khác (mặc định là 3306)
            - '${FORWARD_DB_PORT:-3306}:3306'
        environment:
            # Lấy thông tin database từ file .env
            MYSQL_ROOT_PASSWORD: '${DB_PASSWORD}' # Mật khẩu root của MySQL
            MYSQL_ROOT_HOST: '%' # Cho phép root kết nối từ bất kỳ host nào trong network 'sail'
            MYSQL_DATABASE: '${DB_DATABASE}' # Tên database sẽ được tạo
            MYSQL_USER: '${DB_USERNAME}'     # User sẽ được tạo
            MYSQL_PASSWORD: '${DB_PASSWORD}' # Mật khẩu cho user trên
            MYSQL_ALLOW_EMPTY_PASSWORD: 1    # Cho phép mật khẩu root trống (chỉ nên dùng cho dev)
        volumes:
            # Dùng named volume 'sail-mysql' để lưu dữ liệu database bền bỉ
            - 'sail-mysql:/var/lib/mysql'
            # Chạy script tạo database cho testing (nếu cần)
            - './vendor/laravel/sail/database/mysql/create-testing-database.sh:/docker-entrypoint-initdb.d/10-create-testing-database.sh'
        networks:
            - sail
        healthcheck:
            # Kiểm tra xem service MySQL đã sẵn sàng nhận kết nối chưa
            test: ["CMD", "mysqladmin", "ping", "-p${DB_PASSWORD}"]
            retries: 3
            timeout: 5s

    # <<< SERVICE REDIS ĐÃ THÊM >>>
    redis:
        image: 'redis:alpine' # Dùng image Redis nhẹ (alpine)
        ports:
            # Map cổng Redis ra ngoài nếu cần (mặc định 6379)
            - '${FORWARD_REDIS_PORT:-6379}:6379'
        volumes:
            # Dùng named volume 'sail-redis' để lưu dữ liệu Redis (nếu có cấu hình persistence)
            - 'sail-redis:/data'
        networks:
            - sail
        healthcheck:
            # Kiểm tra xem service Redis đã sẵn sàng chưa
            test: ["CMD", "redis-cli", "ping"]
            retries: 3
            timeout: 5s
    # <<< KẾT THÚC THÊM REDIS >>>

# Định nghĩa network chung cho các service
networks:
    sail:
        driver: bridge

# Định nghĩa các named volume để lưu trữ dữ liệu
volumes:
    sail-mysql:
        driver: local
    # <<< VOLUME REDIS ĐÃ THÊM >>>
    sail-redis:
        driver: local
